<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HK AI</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#06070f;--s1:#0a0c1a;--s2:#0e1122;--s3:#131526;
  --border:rgba(120,140,255,0.1);--border2:rgba(120,140,255,0.06);
  --a1:#6c8eff;--a2:#a78bfa;--a3:#34d399;--a4:#f472b6;
  --text:#dde3ff;--muted:#5a6285;--muted2:#343850;
  --glow:rgba(108,142,255,0.12);
}
html,body{width:100%;height:100%;background:var(--bg);font-family:'Outfit',sans-serif;color:var(--text);overflow:hidden}

/* BG GRID */
body::after{content:"";position:fixed;inset:0;background-image:linear-gradient(rgba(108,142,255,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(108,142,255,0.03) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0}

/* ORBS */
.orbs{position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden}
.orb{position:absolute;border-radius:50%;filter:blur(100px);animation:orbDrift 20s ease-in-out infinite alternate}
.orb:nth-child(1){width:700px;height:700px;background:radial-gradient(circle,rgba(108,142,255,0.08),transparent 60%);top:-300px;right:-200px;animation-duration:18s}
.orb:nth-child(2){width:500px;height:500px;background:radial-gradient(circle,rgba(167,139,250,0.07),transparent 60%);bottom:-200px;left:-100px;animation-duration:24s;animation-delay:-8s}
.orb:nth-child(3){width:300px;height:300px;background:radial-gradient(circle,rgba(52,211,153,0.06),transparent 60%);top:40%;left:40%;animation-duration:16s;animation-delay:-5s}
@keyframes orbDrift{0%{transform:translate(0,0)}100%{transform:translate(30px,50px)}}

/* LAYOUT */
.app{display:flex;height:100vh;position:relative;z-index:1}

/* SIDEBAR */
.sidebar{width:260px;background:rgba(10,12,26,0.85);border-right:1px solid var(--border);display:flex;flex-direction:column;backdrop-filter:blur(24px);flex-shrink:0;transition:width .3s cubic-bezier(.4,0,.2,1);overflow:hidden}
.sidebar.collapsed{width:64px}
.sb-top{padding:18px 16px 12px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)}
.logo{display:flex;align-items:center;gap:10px;text-decoration:none;overflow:hidden}
.logo-icon{width:34px;height:34px;border-radius:9px;background:linear-gradient(135deg,var(--a1),var(--a2));display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:800;color:#fff;flex-shrink:0;letter-spacing:-0.5px}
.logo-name{font-size:17px;font-weight:800;background:linear-gradient(90deg,var(--a1),var(--a2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;white-space:nowrap;transition:opacity .2s}
.sidebar.collapsed .logo-name{opacity:0;width:0}
.sb-toggle{width:28px;height:28px;border-radius:7px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;transition:all .2s}
.sb-toggle:hover{background:var(--glow);color:var(--a1)}

.new-btn{margin:12px;padding:10px;background:linear-gradient(135deg,var(--a1),var(--a2));border:none;border-radius:10px;color:#fff;font-family:'Outfit',sans-serif;font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:7px;transition:opacity .2s;white-space:nowrap;overflow:hidden}
.new-btn:hover{opacity:.85}
.new-btn span{transition:opacity .2s}
.sidebar.collapsed .new-btn span{opacity:0;width:0}

.sb-section{padding:4px 8px;margin-top:2px}
.sb-label{font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted2);padding:8px 8px 4px;white-space:nowrap;overflow:hidden;transition:opacity .2s}
.sidebar.collapsed .sb-label{opacity:0}
.sb-item{display:flex;align-items:center;gap:9px;padding:9px 10px;border-radius:9px;cursor:pointer;font-size:13px;font-weight:500;color:var(--muted);transition:all .15s;white-space:nowrap;overflow:hidden;border:1px solid transparent}
.sb-item:hover{background:rgba(255,255,255,0.04);color:var(--text)}
.sb-item.active{background:rgba(108,142,255,0.1);color:var(--a1);border-color:rgba(108,142,255,0.15)}
.sb-item .ic{font-size:15px;flex-shrink:0;width:18px;text-align:center}
.sb-item-label{transition:opacity .2s;white-space:nowrap}
.sidebar.collapsed .sb-item-label{opacity:0;width:0}

.sb-chat-list{flex:1;overflow-y:auto;padding:4px 8px}
.sb-chat-list::-webkit-scrollbar{width:2px}
.sb-chat-list::-webkit-scrollbar-thumb{background:var(--border)}
.chat-item{padding:9px 10px;border-radius:9px;cursor:pointer;transition:all .15s;margin-bottom:1px;overflow:hidden}
.chat-item:hover{background:rgba(255,255,255,0.04)}
.chat-item.active{background:rgba(108,142,255,0.08);border:1px solid rgba(108,142,255,0.12)}
.ci-title{font-size:12px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px}
.ci-time{font-size:10px;color:var(--muted2);font-family:'DM Mono',monospace}
.sidebar.collapsed .chat-item{opacity:0;pointer-events:none}

.sb-bottom{padding:10px 8px;border-top:1px solid var(--border);margin-top:auto}
.user-row{display:flex;align-items:center;gap:9px;padding:8px 10px;border-radius:9px;cursor:pointer;transition:background .15s;overflow:hidden}
.user-row:hover{background:rgba(255,255,255,0.04)}
.user-av{width:30px;height:30px;border-radius:8px;background:linear-gradient(135deg,var(--a2),var(--a4));display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0}
.user-details{transition:opacity .2s;white-space:nowrap}
.sidebar.collapsed .user-details{opacity:0;width:0}
.user-name{font-size:12px;font-weight:600}
.user-plan{font-size:10px;color:var(--a3);font-family:'DM Mono',monospace}

/* MAIN */
.main{flex:1;display:flex;flex-direction:column;min-width:0;overflow:hidden}

/* TOPBAR */
.topbar{height:52px;border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 20px;gap:12px;background:rgba(6,7,15,0.7);backdrop-filter:blur(20px);flex-shrink:0}
.model-selector{display:flex;align-items:center;gap:8px;background:var(--s2);border:1px solid var(--border);border-radius:9px;padding:6px 12px;font-size:12px;cursor:pointer;transition:border-color .2s;position:relative}
.model-selector:hover{border-color:rgba(108,142,255,0.25)}
.model-dot{width:7px;height:7px;border-radius:50%;background:var(--a3);box-shadow:0 0 6px var(--a3);animation:blink 2s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.4}}
.model-name{font-weight:600;color:var(--text);font-size:12px}
.model-arrow{color:var(--muted);font-size:10px;margin-left:2px}
.source-pills{display:flex;gap:6px;flex:1}
.source-pill{display:flex;align-items:center;gap:5px;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600;border:1px solid;cursor:pointer;transition:all .2s;white-space:nowrap}
.source-pill.web{background:rgba(52,211,153,0.08);border-color:rgba(52,211,153,0.2);color:var(--a3)}
.source-pill.web.off{background:transparent;border-color:var(--border2);color:var(--muted)}
.source-pill.claude{background:rgba(108,142,255,0.08);border-color:rgba(108,142,255,0.2);color:var(--a1)}
.source-pill.claude.off{background:transparent;border-color:var(--border2);color:var(--muted)}
.source-pill.deep{background:rgba(244,114,182,0.08);border-color:rgba(244,114,182,0.2);color:var(--a4)}
.source-pill.deep.off{background:transparent;border-color:var(--border2);color:var(--muted)}
.source-pill:hover{opacity:.85}
.tb-right{display:flex;gap:8px;align-items:center;margin-left:auto}
.tb-btn{width:32px;height:32px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:all .2s}
.tb-btn:hover{background:var(--glow);color:var(--a1);border-color:rgba(108,142,255,0.3)}

/* CHAT AREA */
.chat-wrap{flex:1;overflow-y:auto;padding:32px 0;scroll-behavior:smooth}
.chat-wrap::-webkit-scrollbar{width:4px}
.chat-wrap::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
.chat-inner{max-width:760px;margin:0 auto;padding:0 24px;display:flex;flex-direction:column;gap:24px}

/* WELCOME */
.welcome{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:60vh;text-align:center;gap:20px}
.welcome-icon{width:72px;height:72px;border-radius:20px;background:linear-gradient(135deg,var(--a1),var(--a2));display:flex;align-items:center;justify-content:center;font-size:30px;box-shadow:0 0 50px rgba(108,142,255,0.3),0 0 100px rgba(108,142,255,0.1);animation:iconPulse 3s ease-in-out infinite alternate}
@keyframes iconPulse{0%{box-shadow:0 0 30px rgba(108,142,255,0.2)}100%{box-shadow:0 0 70px rgba(108,142,255,0.45)}}
.welcome h1{font-size:32px;font-weight:800;letter-spacing:-1px;line-height:1.1;background:linear-gradient(135deg,#fff 0%,var(--a1) 50%,var(--a2) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.welcome p{font-size:14px;color:var(--muted);max-width:440px;line-height:1.7}
.source-badges{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
.src-badge{display:flex;align-items:center;gap:6px;padding:6px 12px;background:var(--s2);border:1px solid var(--border);border-radius:20px;font-size:11px;font-weight:600;color:var(--muted)}
.src-badge .dot{width:6px;height:6px;border-radius:50%}
.suggest-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;width:100%;max-width:520px}
.suggest-card{background:var(--s2);border:1px solid var(--border);border-radius:12px;padding:14px 16px;cursor:pointer;transition:all .2s;text-align:left}
.suggest-card:hover{background:var(--s3);border-color:rgba(108,142,255,0.25);transform:translateY(-2px)}
.sc-icon{font-size:18px;margin-bottom:6px}
.sc-text{font-size:12px;font-weight:500;line-height:1.5;color:var(--text)}

/* MESSAGES */
.msg{display:flex;gap:12px;animation:msgSlide .3s ease}
@keyframes msgSlide{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.msg.user{flex-direction:row-reverse}
.msg-av{width:32px;height:32px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;margin-top:2px}
.msg-av.ai{background:linear-gradient(135deg,var(--a1),var(--a2));box-shadow:0 0 12px rgba(108,142,255,0.25)}
.msg-av.user{background:linear-gradient(135deg,var(--a2),var(--a4))}
.msg-content{flex:1;min-width:0;display:flex;flex-direction:column;gap:6px}
.msg.user .msg-content{align-items:flex-end}
.msg-bubble{padding:13px 16px;border-radius:14px;font-size:13.5px;line-height:1.7;max-width:85%}
.msg-bubble.ai{background:var(--s2);border:1px solid var(--border);border-radius:14px 14px 14px 4px}
.msg-bubble.user{background:linear-gradient(135deg,var(--a1),var(--a2));color:#fff;border-radius:14px 14px 4px 14px;max-width:75%}
.msg-bubble.ai pre{background:rgba(0,0,0,0.3);border:1px solid var(--border2);border-radius:8px;padding:12px;margin:8px 0;overflow-x:auto;font-family:'DM Mono',monospace;font-size:12px;line-height:1.6}
.msg-bubble.ai code{font-family:'DM Mono',monospace;font-size:12px;background:rgba(108,142,255,0.1);padding:1px 5px;border-radius:4px}
.msg-bubble.ai strong{color:#fff;font-weight:600}
.msg-bubble.ai ul,
.msg-bubble.ai ol{padding-left:18px;margin:6px 0}
.msg-bubble.ai li{margin-bottom:4px}

/* SOURCE TAGS */
.source-tags{display:flex;gap:6px;flex-wrap:wrap}
.src-tag{display:flex;align-items:center;gap:4px;padding:3px 8px;border-radius:12px;font-size:10px;font-weight:600;font-family:'DM Mono',monospace}
.src-tag.web{background:rgba(52,211,153,0.1);color:var(--a3);border:1px solid rgba(52,211,153,0.15)}
.src-tag.claude{background:rgba(108,142,255,0.1);color:var(--a1);border:1px solid rgba(108,142,255,0.15)}
.src-tag.deep{background:rgba(244,114,182,0.1);color:var(--a4);border:1px solid rgba(244,114,182,0.15)}

.msg-actions{display:flex;gap:6px;opacity:0;transition:opacity .2s}
.msg:hover .msg-actions{opacity:1}
.act-btn{padding:3px 9px;background:var(--s2);border:1px solid var(--border);border-radius:6px;font-size:10px;color:var(--muted);cursor:pointer;font-family:'Outfit',sans-serif;transition:all .15s}
.act-btn:hover{color:var(--a1);border-color:rgba(108,142,255,0.3)}

/* TYPING */
.typing-bubble{display:flex;align-items:center;gap:12px;padding:13px 16px;background:var(--s2);border:1px solid var(--border);border-radius:14px 14px 14px 4px;width:fit-content}
.typing-dots{display:flex;gap:5px}
.typing-dots span{width:6px;height:6px;border-radius:50%;background:var(--a1);animation:td .9s infinite}
.typing-dots span:nth-child(2){animation-delay:.15s}
.typing-dots span:nth-child(3){animation-delay:.3s}
@keyframes td{0%,60%,100%{opacity:.2;transform:translateY(0)}30%{opacity:1;transform:translateY(-3px)}}
.typing-label{font-size:11px;color:var(--muted);font-family:'DM Mono',monospace}

/* SEARCH INDICATOR */
.search-indicator{display:flex;align-items:center;gap:8px;padding:8px 12px;background:rgba(52,211,153,0.06);border:1px solid rgba(52,211,153,0.12);border-radius:10px;font-size:11px;color:var(--a3);width:fit-content;margin-bottom:4px}
.search-spin{width:12px;height:12px;border:2px solid rgba(52,211,153,0.2);border-top-color:var(--a3);border-radius:50%;animation:spin .7s linear infinite;flex-shrink:0}
@keyframes spin{to{transform:rotate(360deg)}}

/* INPUT */
.input-area{padding:16px 24px 20px;border-top:1px solid var(--border);background:rgba(6,7,15,0.8);backdrop-filter:blur(20px);flex-shrink:0}
.input-wrap{max-width:760px;margin:0 auto}
.input-box{background:var(--s2);border:1px solid var(--border);border-radius:14px;transition:border-color .25s,box-shadow .25s;overflow:hidden}
.input-box:focus-within{border-color:rgba(108,142,255,0.4);box-shadow:0 0 0 3px rgba(108,142,255,0.07)}
.input-row{display:flex;align-items:flex-end;padding:10px 14px;gap:10px}
.input-row textarea{flex:1;background:none;border:none;outline:none;color:var(--text);font-family:'Outfit',sans-serif;font-size:13.5px;resize:none;line-height:1.6;max-height:140px}
.input-row textarea::placeholder{color:var(--muted)}
.send-btn{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--a1),var(--a2));border:none;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;transition:all .2s;box-shadow:0 4px 12px rgba(108,142,255,0.3)}
.send-btn:hover{transform:scale(1.05);box-shadow:0 6px 20px rgba(108,142,255,0.4)}
.send-btn:disabled{opacity:.35;cursor:not-allowed;transform:none}
.input-footer{display:flex;align-items:center;gap:8px;padding:8px 14px 10px;border-top:1px solid var(--border2)}
.input-tool{width:26px;height:26px;border-radius:7px;border:1px solid var(--border2);background:transparent;color:var(--muted);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:12px;transition:all .2s}
.input-tool:hover{background:var(--glow);color:var(--a1);border-color:rgba(108,142,255,0.3)}
.input-hint{font-size:11px;color:var(--muted2);margin-left:auto;font-family:'DM Mono',monospace}

/* SUGGESTIONS */
.quick-suggestions{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px}
.qs-chip{padding:6px 12px;background:var(--s2);border:1px solid var(--border);border-radius:20px;font-size:11px;color:var(--muted);cursor:pointer;transition:all .2s;white-space:nowrap}
.qs-chip:hover{background:var(--glow);color:var(--a1);border-color:rgba(108,142,255,0.25)}

/* MODEL DROPDOWN */
.model-dropdown{position:absolute;top:42px;left:0;background:var(--s2);border:1px solid var(--border);border-radius:12px;padding:6px;z-index:100;min-width:200px;box-shadow:0 12px 40px rgba(0,0,0,0.5);display:none}
.model-dropdown.open{display:block}
.model-opt{padding:9px 12px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:500;transition:background .15s;display:flex;align-items:center;gap:8px}
.model-opt:hover{background:rgba(255,255,255,0.05)}
.model-opt.active{color:var(--a1)}
.model-opt-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}

/* TOAST */
.toast{position:fixed;bottom:24px;right:24px;z-index:999;background:var(--s2);border:1px solid var(--border);border-radius:12px;padding:11px 18px;font-size:12px;font-weight:600;display:none;align-items:center;gap:8px;backdrop-filter:blur(20px);box-shadow:0 8px 32px rgba(0,0,0,0.4);animation:toastIn .3s ease}
.toast.show{display:flex}
@keyframes toastIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* ===== TRIAL BANNER ===== */
.trial-banner{position:fixed;top:0;left:0;right:0;z-index:9999;background:linear-gradient(90deg,#6c8eff,#a78bfa,#34d399);padding:0;height:0;overflow:hidden;transition:height .3s;display:flex;align-items:center;justify-content:center;gap:16px;font-size:12px;font-weight:600;color:#fff}
.trial-banner.show{height:36px}
.trial-banner .countdown{font-family:'DM Mono',monospace;background:rgba(0,0,0,0.2);padding:3px 10px;border-radius:20px}
.trial-banner .upgrade-link{background:rgba(255,255,255,0.25);padding:4px 12px;border-radius:20px;cursor:pointer;transition:background .2s}
.trial-banner .upgrade-link:hover{background:rgba(255,255,255,0.4)}

/* ===== UPLOAD COUNTER (top right) ===== */
.upload-counter{display:flex;align-items:center;gap:6px;background:var(--s2);border:1px solid var(--border);border-radius:9px;padding:5px 10px;font-size:11px;font-weight:600;font-family:'DM Mono',monospace;cursor:pointer;transition:all .2s}
.upload-counter:hover{border-color:rgba(108,142,255,0.3)}
.upload-counter .uc-bar{width:40px;height:4px;background:var(--muted2);border-radius:2px;overflow:hidden}
.upload-counter .uc-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--a3),var(--a1));transition:width .3s}
.upload-counter.warning .uc-fill{background:linear-gradient(90deg,#f59e0b,#ef4444)}
.upload-counter.danger{border-color:rgba(239,68,68,0.4);color:var(--error)}
.upload-counter.danger .uc-fill{background:var(--error)}

/* ===== UPGRADE MODAL ===== */
.upgrade-overlay{position:fixed;inset:0;z-index:9000;background:rgba(0,0,0,0.8);backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center}
.upgrade-overlay.show{display:flex}
.upgrade-modal{background:var(--s1);border:1px solid rgba(108,142,255,0.2);border-radius:20px;padding:36px;max-width:520px;width:90%;text-align:center;box-shadow:0 30px 80px rgba(0,0,0,0.6);animation:modalIn .3s ease}
@keyframes modalIn{from{opacity:0;transform:scale(0.95) translateY(10px)}to{opacity:1;transform:scale(1) translateY(0)}}
.upgrade-modal .um-icon{font-size:48px;margin-bottom:12px}
.upgrade-modal h2{font-family:'Outfit',sans-serif;font-size:24px;font-weight:800;margin-bottom:8px;background:linear-gradient(135deg,#fff,var(--a1));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.upgrade-modal p{font-size:13px;color:var(--muted);line-height:1.7;margin-bottom:24px}
.plans-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:24px}
.plan-card{background:var(--s2);border:1px solid var(--border);border-radius:14px;padding:18px;text-align:left;cursor:pointer;transition:all .2s;position:relative}
.plan-card:hover{border-color:rgba(108,142,255,0.4);transform:translateY(-2px)}
.plan-card.popular{border-color:rgba(108,142,255,0.5);background:rgba(108,142,255,0.06)}
.plan-badge{position:absolute;top:-10px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,var(--a1),var(--a2));color:#fff;font-size:10px;font-weight:700;padding:3px 12px;border-radius:20px;white-space:nowrap}
.plan-name{font-size:14px;font-weight:700;margin-bottom:4px}
.plan-price{font-family:'DM Mono',monospace;font-size:22px;font-weight:700;color:var(--a1);margin-bottom:8px}
.plan-price span{font-size:12px;color:var(--muted);font-family:'Outfit',sans-serif}
.plan-features{font-size:11px;color:var(--muted);line-height:1.8}
.plan-features li{list-style:none;padding-left:16px;position:relative}
.plan-features li::before{content:"‚úì";position:absolute;left:0;color:var(--a3);font-weight:700}
.upgrade-close{margin-top:8px;background:none;border:none;color:var(--muted);font-size:12px;cursor:pointer;font-family:'Outfit',sans-serif}
.upgrade-close:hover{color:var(--text)}

/* MODE BUTTONS */
.mode-btn.active{background:rgba(108,142,255,0.15);color:var(--a1);border-color:rgba(108,142,255,0.4)}
.mode-btn[id="mode-image"].active{background:rgba(244,114,182,0.12);color:var(--a4);border-color:rgba(244,114,182,0.35)}
.mode-btn[id="mode-video"].active{background:rgba(245,158,11,0.12);color:#f59e0b;border-color:rgba(245,158,11,0.35)}

/* GENERATED MEDIA IN CHAT */
.media-bubble{background:var(--s2);border:1px solid var(--border);border-radius:14px 14px 14px 4px;overflow:hidden;max-width:85%;width:420px}
.media-bubble img{width:100%;display:block;border-radius:0}
.media-bubble .media-caption{padding:10px 14px;font-size:11px;color:var(--muted);font-family:'DM Mono',monospace;border-top:1px solid var(--border2);display:flex;align-items:center;justify-content:space-between}
.media-bubble .media-caption a{color:var(--a1);text-decoration:none;font-size:10px}
.media-bubble .media-caption a:hover{text-decoration:underline}
.media-label{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:20px;font-size:10px;font-weight:700;margin-bottom:6px;width:fit-content}
.media-label.img-label{background:rgba(244,114,182,0.12);color:var(--a4);border:1px solid rgba(244,114,182,0.2)}
.media-label.vid-label{background:rgba(245,158,11,0.1);color:#f59e0b;border:1px solid rgba(245,158,11,0.2)}
.video-bubble{background:var(--s2);border:1px solid var(--border);border-radius:14px 14px 14px 4px;overflow:hidden;max-width:85%;width:420px}
.video-thumb{background:linear-gradient(135deg,#0a0c1a,#1a1a3e);aspect-ratio:16/9;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;position:relative;cursor:pointer}
.video-thumb .play-btn{width:56px;height:56px;border-radius:50%;background:rgba(255,255,255,0.15);backdrop-filter:blur(8px);border:2px solid rgba(255,255,255,0.3);display:flex;align-items:center;justify-content:center;font-size:20px;transition:all .2s}
.video-thumb:hover .play-btn{background:rgba(108,142,255,0.3);transform:scale(1.1)}
.video-thumb .vid-overlay{position:absolute;inset:0;background:linear-gradient(135deg,rgba(108,142,255,0.08),rgba(167,139,250,0.08));animation:vidShimmer 3s infinite alternate}
@keyframes vidShimmer{0%{opacity:0.4}100%{opacity:1}}
.video-thumb .vid-desc{font-size:11px;color:rgba(255,255,255,0.6);max-width:80%;text-align:center;line-height:1.5;z-index:1}
.video-bubble .media-caption{padding:10px 14px;font-size:11px;color:var(--muted);font-family:'DM Mono',monospace;border-top:1px solid var(--border2);display:flex;align-items:center;justify-content:space-between}
.gen-progress-bubble{background:var(--s2);border:1px solid var(--border);border-radius:14px 14px 14px 4px;padding:14px 16px;max-width:85%;width:320px}
.gen-progress-bubble .gp-title{font-size:12px;font-weight:600;margin-bottom:10px;display:flex;align-items:center;gap:6px}
.gen-progress-bubble .gp-bar{height:4px;background:var(--muted2);border-radius:2px;overflow:hidden;margin-bottom:6px}
.gen-progress-bubble .gp-fill{height:100%;border-radius:2px;transition:width .4s ease}
.gen-progress-bubble .gp-status{font-size:10px;color:var(--muted);font-family:'DM Mono',monospace}
.photo-layout{padding:24px;overflow-y:auto;height:100%;display:flex;flex-direction:column;gap:16px}
.photo-layout::-webkit-scrollbar{width:4px}
.photo-layout::-webkit-scrollbar-thumb{background:var(--border)}
.photo-tabs{display:flex;gap:8px;margin-bottom:4px}
.ptab{padding:8px 18px;border-radius:9px;border:1px solid var(--border);background:transparent;color:var(--muted);font-family:'Outfit',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:all .2s}
.ptab.active{background:rgba(108,142,255,0.12);color:var(--a1);border-color:rgba(108,142,255,0.3)}
.photo-gen-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.pcard{background:var(--s2);border:1px solid var(--border);border-radius:14px;padding:20px}
.pcard-title{font-size:13px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.pcard .tf-group{margin-bottom:12px}
.pcard .tf-label{font-size:10px;font-weight:700;letter-spacing:1.2px;text-transform:uppercase;color:var(--muted);margin-bottom:6px;display:block}
.pcard .tf-input,.pcard .tf-select,.pcard .tf-textarea{width:100%;background:var(--s3);border:1px solid var(--border);border-radius:9px;padding:9px 12px;font-family:'Outfit',sans-serif;font-size:12px;color:var(--text);outline:none;transition:border-color .2s}
.pcard .tf-input:focus,.pcard .tf-select:focus,.pcard .tf-textarea:focus{border-color:rgba(108,142,255,0.4)}
.pcard .tf-textarea{height:90px;resize:vertical;padding-top:9px}
.pcard .tf-select option{background:var(--s2)}
.pcard .tf-input::placeholder,.pcard .tf-textarea::placeholder{color:var(--muted2)}
.photo-preview{background:var(--s3);border:1px solid var(--border);border-radius:10px;aspect-ratio:1;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:10px;margin-bottom:12px;position:relative;overflow:hidden;max-height:280px}
.photo-preview img{width:100%;height:100%;object-fit:cover;border-radius:10px}
.photo-preview.generating::after{content:"";position:absolute;inset:0;background:linear-gradient(135deg,rgba(108,142,255,0.1),rgba(167,139,250,0.1),rgba(52,211,153,0.1));animation:photoShimmer 2s infinite}
@keyframes photoShimmer{0%,100%{opacity:0.3}50%{opacity:1}}
.photo-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.photo-item{aspect-ratio:1;background:var(--s3);border:1px solid var(--border);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:28px;cursor:pointer;transition:all .2s;position:relative;overflow:hidden}
.photo-item:hover{border-color:rgba(108,142,255,0.3);transform:scale(1.03)}
.photo-item-label{position:absolute;bottom:0;left:0;right:0;padding:5px;background:rgba(0,0,0,0.65);font-size:9px;color:var(--muted);text-align:center}
.style-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px}
.style-opt{padding:10px 6px;background:var(--s3);border:1px solid var(--border);border-radius:9px;text-align:center;cursor:pointer;transition:all .2s;font-size:11px;color:var(--muted)}
.style-opt:hover,.style-opt.active{background:rgba(108,142,255,0.1);border-color:rgba(108,142,255,0.3);color:var(--a1)}
.style-opt .so-icon{font-size:18px;display:block;margin-bottom:4px}
.aspect-btns{display:flex;gap:6px;margin-bottom:14px}
.aspect-btn{padding:6px 12px;background:var(--s3);border:1px solid var(--border);border-radius:7px;color:var(--muted);font-size:11px;font-weight:600;cursor:pointer;transition:all .2s;font-family:'Outfit',sans-serif}
.aspect-btn.active{background:rgba(108,142,255,0.12);border-color:rgba(108,142,255,0.3);color:var(--a1)}
.edit-canvas{background:var(--s3);border:1px solid var(--border);border-radius:10px;aspect-ratio:4/3;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px;position:relative;overflow:hidden;margin-bottom:12px;cursor:pointer}
.edit-canvas.has-image{cursor:default}
.photo-edit-tools{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:14px}
.pet-btn{padding:10px 6px;background:var(--s3);border:1px solid var(--border);border-radius:9px;text-align:center;cursor:pointer;transition:all .2s}
.pet-btn:hover{background:rgba(108,142,255,0.1);border-color:rgba(108,142,255,0.3);transform:translateY(-2px)}
.pet-icon{font-size:18px;display:block;margin-bottom:3px}
.pet-label{font-size:9px;color:var(--muted)}
.slider-row{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.slider-label{font-size:11px;color:var(--muted);width:80px;flex-shrink:0}
.slider-input{flex:1;accent-color:var(--a1)}
.slider-val{font-size:11px;color:var(--a1);width:30px;text-align:right;font-family:'DM Mono',monospace}

/* ===== VIDEO PAGE ===== */
/* ===== VIDEO PAGE ===== */
.video-layout{padding:24px;overflow-y:auto;height:100%;display:flex;flex-direction:column;gap:16px}
.video-layout::-webkit-scrollbar{width:4px}
.video-layout::-webkit-scrollbar-thumb{background:var(--border)}
.video-tabs{display:flex;gap:8px;margin-bottom:4px}
.vtab{padding:8px 18px;border-radius:9px;border:1px solid var(--border);background:transparent;color:var(--muted);font-family:'Outfit',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:all .2s}
.vtab.active{background:rgba(108,142,255,0.12);color:var(--a1);border-color:rgba(108,142,255,0.3)}
.video-gen-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.vcard{background:var(--s2);border:1px solid var(--border);border-radius:14px;padding:20px}
.vcard-title{font-size:13px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.vcard .tf-group{margin-bottom:12px}
.vcard .tf-label{font-size:10px;font-weight:700;letter-spacing:1.2px;text-transform:uppercase;color:var(--muted);margin-bottom:6px;display:block}
.vcard .tf-input,.vcard .tf-select,.vcard .tf-textarea{width:100%;background:var(--s3);border:1px solid var(--border);border-radius:9px;padding:9px 12px;font-family:'Outfit',sans-serif;font-size:12px;color:var(--text);outline:none;transition:border-color .2s}
.vcard .tf-input:focus,.vcard .tf-select:focus,.vcard .tf-textarea:focus{border-color:rgba(108,142,255,0.4)}
.vcard .tf-textarea{height:90px;resize:vertical;padding-top:9px}
.vcard .tf-select option{background:var(--s2)}
.vcard .tf-input::placeholder,.vcard .tf-textarea::placeholder{color:var(--muted2)}
.gen-btn{width:100%;padding:11px;background:linear-gradient(135deg,var(--a1),var(--a2));border:none;border-radius:10px;color:#fff;font-family:'Outfit',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:opacity .2s;display:flex;align-items:center;justify-content:center;gap:8px}
.gen-btn:hover{opacity:.85}
.gen-btn:disabled{opacity:.4;cursor:not-allowed}
.video-preview{background:var(--s3);border:1px solid var(--border);border-radius:10px;aspect-ratio:16/9;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:10px;margin-bottom:12px;position:relative;overflow:hidden}
.video-preview.generating::after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(108,142,255,0.1),transparent);animation:shimmer 1.5s infinite}
@keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
.vp-icon{font-size:32px}
.vp-text{font-size:12px;color:var(--muted)}
.vp-progress{width:80%;height:4px;background:var(--muted2);border-radius:2px;overflow:hidden;display:none}
.vp-progress.show{display:block}
.vp-progress-fill{height:100%;background:linear-gradient(90deg,var(--a1),var(--a2));border-radius:2px;transition:width .3s}
.video-samples{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.vsample{background:var(--s3);border:1px solid var(--border);border-radius:10px;aspect-ratio:16/9;display:flex;align-items:center;justify-content:center;font-size:24px;cursor:pointer;transition:all .2s;position:relative;overflow:hidden}
.vsample:hover{border-color:rgba(108,142,255,0.3);transform:scale(1.02)}
.vsample-label{position:absolute;bottom:0;left:0;right:0;padding:6px;background:rgba(0,0,0,0.6);font-size:10px;color:var(--muted);text-align:center}
.edit-tools{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:14px}
.edit-tool-btn{padding:10px;background:var(--s3);border:1px solid var(--border);border-radius:10px;cursor:pointer;font-size:20px;text-align:center;transition:all .2s}
.edit-tool-btn:hover{background:rgba(108,142,255,0.1);border-color:rgba(108,142,255,0.3);transform:translateY(-2px)}
.edit-tool-label{font-size:10px;color:var(--muted);margin-top:4px}
</style>
</style>
</head>
<body>
<div class="orbs"><div class="orb"></div><div class="orb"></div><div class="orb"></div></div>

<div class="app">
  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <div class="sb-top">
      <div class="logo">
        <div class="logo-icon">HK</div>
        <div class="logo-name">HK AI</div>
      </div>
      <button class="sb-toggle" onclick="toggleSidebar()">‚óÄ</button>
    </div>

    <button class="new-btn" onclick="newChat()">‚ú¶ <span>New Chat</span></button>

    <div class="sb-section">
      <div class="sb-label">Recent Chats</div>
    </div>

    <div class="sb-chat-list" id="chat-list">
      <div class="chat-item active"><div class="ci-title">What is quantum computing?</div><div class="ci-time">just now</div></div>
      <div class="chat-item"><div class="ci-title">Best programming languages 2025</div><div class="ci-time">1h ago</div></div>
      <div class="chat-item"><div class="ci-title">How does the stock market work?</div><div class="ci-time">3h ago</div></div>
      <div class="chat-item"><div class="ci-title">Latest news in AI research</div><div class="ci-time">Yesterday</div></div>
      <div class="chat-item"><div class="ci-title">Explain black holes simply</div><div class="ci-time">2d ago</div></div>
      <div class="chat-item"><div class="ci-title">Write a Python web scraper</div><div class="ci-time">3d ago</div></div>
    </div>

    <div class="sb-bottom">
      <div class="user-row">
        <div class="user-av">H</div>
        <div class="user-details">
          <div class="user-name">Hesbordean</div>
          <div class="user-plan">PRO PLAN</div>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <!-- TOPBAR -->
    <div class="topbar">
      <div class="model-selector" onclick="toggleModelDropdown()" id="model-selector">
        <div class="model-dot"></div>
        <span class="model-name" id="model-name">HK AI Pro</span>
        <span class="model-arrow">‚ñæ</span>
        <div class="model-dropdown" id="model-dropdown">
          <div class="model-opt active" onclick="setModel('HK AI Pro',this)"><div class="model-opt-dot" style="background:var(--a3)"></div>HK AI Pro ‚Äî Most capable</div>
          <div class="model-opt" onclick="setModel('HK AI Fast',this)"><div class="model-opt-dot" style="background:var(--a1)"></div>HK AI Fast ‚Äî Quick answers</div>
          <div class="model-opt" onclick="setModel('HK AI Research',this)"><div class="model-opt-dot" style="background:var(--a4)"></div>HK AI Research ‚Äî Deep search</div>
        </div>
      </div>

      <div class="source-pills">
        <div class="source-pill web" id="pill-web" onclick="toggleSource('web')" title="Search the web for real-time info">üåê Web Search</div>
        <div class="source-pill claude" id="pill-claude" onclick="toggleSource('claude')" title="Use Claude AI reasoning">‚ú¶ Claude</div>
        <div class="source-pill deep" id="pill-deep" onclick="toggleSource('deep')" title="Deep research mode">üî¨ Deep Research</div>
      </div>

      <div class="tb-right">
      <img src="hk-ai-logo.svg" alt="HK AI Logo" style="height:36px;width:36px;border-radius:8px;object-fit:contain;cursor:pointer" onclick="showToast('Hesbordean KE','‚ú¶')">
        <div class="upload-counter" id="upload-counter" onclick="showUpgrade()" title="File uploads remaining">
        üìé <span id="upload-count">10</span>/10
        <div class="uc-bar"><div class="uc-fill" id="uc-fill" style="width:100%"></div></div>
      </div>
      <button class="tb-btn" title="Share" onclick="showToast('Link copied!','‚úÖ')">üîó</button>
        <div id="dalle-topbar-indicator" style="display:none;align-items:center;gap:5px;background:rgba(16,163,127,0.1);border:1px solid rgba(16,163,127,0.25);border-radius:8px;padding:4px 10px;font-size:10px;font-weight:700;color:#10a37f;cursor:pointer" onclick="openSettings()" title="DALL-E 3 active">üé® DALL-E 3</div>
        <button class="tb-btn" title="Settings" onclick="openSettings()">‚öôÔ∏è</button>
      </div>
    </div>

    <!-- CHAT -->
    <div class="chat-wrap" id="chat-wrap">
      <div class="chat-inner" id="chat-inner">
        <!-- WELCOME -->
        <div class="welcome" id="welcome-screen">
          <div class="welcome-icon">‚ú¶</div>
          <h1>Create anything.</h1>
          <p>HK AI generates images, creates videos, answers questions, and reasons with advanced AI ‚Äî all from a single prompt.</p>
          <div class="source-badges">
            <div class="src-badge"><div class="dot" style="background:var(--a4)"></div>Image Generation</div>
            <div class="src-badge"><div class="dot" style="background:#f59e0b"></div>Video Generation</div>
            <div class="src-badge"><div class="dot" style="background:var(--a1)"></div>Claude AI</div>
            <div class="src-badge"><div class="dot" style="background:var(--a3)"></div>Web Search</div>
          </div>
          <div class="suggest-grid">
            <div class="suggest-card" onclick="usePrompt(this)">
              <div class="sc-icon">üñºÔ∏è</div>
              <div class="sc-text">Generate an image of a futuristic Nairobi city at night with neon lights</div>
            </div>
            <div class="suggest-card" onclick="usePrompt(this)">
              <div class="sc-icon">üé¨</div>
              <div class="sc-text">Create a video of a lion walking across the African savanna at golden hour</div>
            </div>
            <div class="suggest-card" onclick="usePrompt(this)">
              <div class="sc-icon">üåÖ</div>
              <div class="sc-text">Generate a photorealistic portrait of an African woman in traditional attire</div>
            </div>
            <div class="suggest-card" onclick="usePrompt(this)">
              <div class="sc-icon">üí°</div>
              <div class="sc-text">What are the latest breakthroughs in AI research?</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- INPUT -->
    <div class="input-area">
      <div class="input-wrap">
        <div class="quick-suggestions" id="quick-suggestions">
          <div class="qs-chip" onclick="useChip(this)">üñºÔ∏è Generate image</div>
          <div class="qs-chip" onclick="useChip(this)">üé¨ Create video</div>
          <div class="qs-chip" onclick="useChip(this)">üåê Latest news</div>
          <div class="qs-chip" onclick="useChip(this)">üíª Write code</div>
          <div class="qs-chip" onclick="useChip(this)">üî¨ Research topic</div>
        </div>
        <div class="input-box">
          <div class="input-row">
            <textarea id="msg-input" placeholder="Ask anything, generate an image, or create a video..." rows="1"
              onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
            <button class="send-btn" id="send-btn" onclick="sendMessage()">‚û§</button>
          </div>
          <div class="input-footer">
            <button class="input-tool mode-btn active" id="mode-chat" title="Chat mode" onclick="setMode('chat',this)">üí¨</button>
            <button class="input-tool mode-btn" id="mode-image" title="Image generation mode" onclick="setMode('image',this)">üñºÔ∏è</button>
            <button class="input-tool mode-btn" id="mode-video" title="Video generation mode" onclick="setMode('video',this)">üé¨</button>
            <div style="width:1px;height:16px;background:var(--border2);margin:0 4px"></div>
            <button class="input-tool" title="Attach file">üìé</button>
            <div class="input-hint" id="mode-hint">Chat ¬∑ Shift+Enter for new line</div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ===== STATE =====
let sources = {web: true, claude: true, deep: false};
let currentModel = 'HK AI Pro';
let isLoading = false;
let msgHistory = [];
let currentMode = 'chat'; // 'chat' | 'image' | 'video'

function setMode(mode, el) {
  currentMode = mode;
  document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  const hints = {chat:'Chat ¬∑ Shift+Enter for new line', image:'Image Generation ¬∑ describe your image', video:'Video Generation ¬∑ describe your video'};
  const placeholders = {chat:'Ask anything, generate an image, or create a video...', image:'Describe the image you want to generate...', video:'Describe the video scene you want to create...'};
  const hintEl = document.getElementById('mode-hint');
  const input = document.getElementById('msg-input');
  if (hintEl) hintEl.textContent = hints[mode];
  if (input) input.placeholder = placeholders[mode];
}

// ===== TRIAL & UPLOAD SYSTEM =====
const TRIAL_DAYS = 30;
const MAX_UPLOADS = 10;
const MAX_CHATS = 999999; // unlimited

function initTrial() {
  if (!localStorage.getItem('hkai_trial_start')) {
    localStorage.setItem('hkai_trial_start', Date.now().toString());
  }
  if (!localStorage.getItem('hkai_uploads')) {
    localStorage.setItem('hkai_uploads', '0');
  }
  updateTrialBanner();
  updateUploadCounter();
  setInterval(updateTrialBanner, 60000);
}

function updateTrialBanner() {
  const start = parseInt(localStorage.getItem('hkai_trial_start') || Date.now());
  const elapsed = Date.now() - start;
  const daysLeft = Math.max(0, TRIAL_DAYS - Math.floor(elapsed / (1000*60*60*24)));
  const totalMinsLeft = Math.max(0, Math.floor((TRIAL_DAYS*24*60) - elapsed/(1000*60)));
  const hoursLeft = Math.floor(totalMinsLeft / 60) % 24;
  const minsLeft = totalMinsLeft % 60;
  const daysEl = document.getElementById('trial-days');
  const countdownEl = document.getElementById('trial-countdown');
  const banner = document.getElementById('trial-banner');
  if (daysEl) daysEl.textContent = daysLeft;
  if (countdownEl) countdownEl.textContent = daysLeft > 0 ? daysLeft + 'd ' + hoursLeft + 'h ' + minsLeft + 'm left' : 'Trial expired!';
  if (banner) { banner.classList.add('show'); document.querySelector('.app').style.marginTop = '36px'; }
  if (daysLeft === 0) showUpgrade();
}

function getUploadsUsed() {
  return parseInt(localStorage.getItem('hkai_uploads') || '0');
}

function updateUploadCounter() {
  const used = getUploadsUsed();
  const remaining = Math.max(0, MAX_UPLOADS - used);
  const pct = (remaining / MAX_UPLOADS) * 100;
  const counter = document.getElementById('upload-counter');
  const countEl = document.getElementById('upload-count');
  const fillEl = document.getElementById('uc-fill');
  if (countEl) countEl.textContent = remaining;
  if (fillEl) fillEl.style.width = pct + '%';
  if (counter) {
    counter.classList.remove('warning','danger');
    if (remaining <= 3 && remaining > 0) counter.classList.add('warning');
    if (remaining <= 0) counter.classList.add('danger');
  }
}

function useUpload(label) {
  const used = getUploadsUsed();
  if (used >= MAX_UPLOADS) {
    showUpgrade('uploads');
    return false;
  }
  localStorage.setItem('hkai_uploads', (used + 1).toString());
  updateUploadCounter();
  const remaining = MAX_UPLOADS - used - 1;
  if (remaining <= 3 && remaining > 0) showToast(remaining + ' uploads remaining on free plan', 'warning');
  return true;
}

// ===== UPGRADE MODAL =====
function showUpgrade(reason) {
  const el = document.getElementById('upgrade-overlay');
  if (el) el.classList.add('show');
  const subtitle = document.getElementById('upgrade-reason');
  if (subtitle) {
    if (reason === 'uploads') subtitle.textContent = 'You have used all 10 free file uploads. Upgrade for 50+ uploads per month.';
    else if (reason === 'trial') subtitle.textContent = 'Your 30-day free trial has ended. Upgrade to keep using HK AI.';
    else subtitle.textContent = 'Upgrade to continue with unlimited chats, more uploads, video generation, and priority AI responses.';
  }
}
function closeUpgrade() {
  const el = document.getElementById('upgrade-overlay');
  if (el) el.classList.remove('show');
}
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeUpgrade(); });

// ===== SETTINGS & DALL-E KEY =====
function openSettings() {
  const overlay = document.getElementById('settings-overlay');
  if (overlay) overlay.classList.add('show');
  // Load saved key preview
  const key = localStorage.getItem('hkai_dalle_key') || '';
  const input = document.getElementById('dalle-key-input');
  if (input && key) input.placeholder = key.substring(0,7) + '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + key.slice(-4);
  updateDalleStatusBadge();
}
function closeSettings() {
  const overlay = document.getElementById('settings-overlay');
  if (overlay) overlay.classList.remove('show');
}
function saveDalleKey() {
  const input = document.getElementById('dalle-key-input');
  const key = input ? input.value.trim() : '';
  if (!key.startsWith('sk-')) { showToast('Invalid key ‚Äî must start with sk-', 'error'); return; }
  localStorage.setItem('hkai_dalle_key', key);
  if (input) { input.value = ''; input.placeholder = key.substring(0,7) + '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + key.slice(-4); }
  const saved = document.getElementById('dalle-key-saved');
  if (saved) saved.style.display = 'block';
  updateDalleStatusBadge();
  updateTopbarKeyIndicator();
  showToast('DALL-E 3 activated! üé®', 'ok');
}
function updateDalleStatusBadge() {
  const key = localStorage.getItem('hkai_dalle_key');
  const badge = document.getElementById('dalle-status-badge');
  if (!badge) return;
  if (key) {
    badge.style.background = 'rgba(52,211,153,0.1)';
    badge.style.color = 'var(--a3)';
    badge.style.borderColor = 'rgba(52,211,153,0.2)';
    badge.textContent = '‚úì Active';
  } else {
    badge.style.background = 'rgba(239,68,68,0.1)';
    badge.style.color = '#ef4444';
    badge.style.borderColor = 'rgba(239,68,68,0.2)';
    badge.textContent = 'Not set';
  }
}
function updateTopbarKeyIndicator() {
  const key = localStorage.getItem('hkai_dalle_key');
  const ind = document.getElementById('dalle-topbar-indicator');
  if (ind) {
    ind.style.display = key ? 'flex' : 'none';
  }
}
function toggleSidebar() {
  const sb = document.getElementById('sidebar');
  sb.classList.toggle('collapsed');
  document.querySelector('.sb-toggle').textContent = sb.classList.contains('collapsed') ? '>' : '<';
}

// ===== NAVIGATION =====
function showPage(id, el) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  const page = document.getElementById('page-' + id);
  if (page) page.classList.add('active');
  document.querySelectorAll('.sb-item').forEach(n => n.classList.remove('active'));
  if (el) el.classList.add('active');
  else {
    document.querySelectorAll('.sb-item').forEach(n => {
      if (n.getAttribute('onclick') && n.getAttribute('onclick').indexOf("'" + id + "'") > -1) n.classList.add('active');
    });
  }
  const titles = {chat:'Chat',capabilities:'Capabilities',tasks:'Tasks',generate:'Generate',
    video:'Video AI',photo:'Photo AI',integrations:'Integrations',analytics:'Analytics',settings:'Settings'};
  const titleEl = document.getElementById('page-title');
  if (titleEl) titleEl.textContent = titles[id] || id;
  if (id === 'analytics') buildBarChart();
}

// ===== MODEL =====
function toggleModelDropdown() {
  document.getElementById('model-dropdown').classList.toggle('open');
}
function setModel(name, el) {
  currentModel = name;
  document.getElementById('model-name').textContent = name;
  document.querySelectorAll('.model-opt').forEach(o => o.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('model-dropdown').classList.remove('open');
  showToast('Switched to ' + name, 'star');
  event.stopPropagation();
}
document.addEventListener('click', e => {
  if (!e.target.closest('#model-selector')) {
    const dd = document.getElementById('model-dropdown');
    if (dd) dd.classList.remove('open');
  }
});

// ===== SOURCES =====
function toggleSource(src) {
  sources[src] = !sources[src];
  const pill = document.getElementById('pill-' + src);
  if (pill) pill.classList.toggle('off', !sources[src]);
}

// ===== CHAT (unlimited) =====
function hideWelcome() {
  const w = document.getElementById('welcome-screen');
  if (w) w.style.display = 'none';
  const qs = document.getElementById('quick-suggestions');
  if (qs) qs.style.display = 'none';
}

function usePrompt(el) {
  const input = document.getElementById('msg-input');
  if (input) input.value = el.querySelector('.sc-text').textContent;
  sendMessage();
}

function useChip(el) {
  const map = {
    'Generate image': 'Generate image of ',
    'Create video': 'Create a video of ',
    'Latest news': 'What is the latest news happening around the world today?',
    'Write code': 'Write me a useful code snippet.',
    'Research topic': 'Research a fascinating topic and give me a detailed summary.',
  };
  const key = el.textContent.trim().replace(/^[^\s]+\s/, '');
  const val = map[key] || el.textContent.trim();
  const input = document.getElementById('msg-input');
  if (input) { input.value = val; input.focus(); }
  // Auto-switch mode
  if (key === 'Generate image') setMode('image', document.getElementById('mode-image'));
  if (key === 'Create video') setMode('video', document.getElementById('mode-video'));
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 140) + 'px';
}

async function sendMessage() {
  const input = document.getElementById('msg-input');
  const text = input.value.trim();
  if (!text || isLoading) return;

  // Detect intent
  const lc = text.toLowerCase();
  const isImageRequest = currentMode === 'image' ||
    /\b(generate|create|make|draw|paint|design|show me|render|produce)\b.{0,30}\b(image|photo|picture|portrait|illustration|artwork|drawing|painting|art|wallpaper|poster)\b/i.test(text) ||
    /\b(image|photo|picture|portrait|illustration) of\b/i.test(text);
  const isVideoRequest = currentMode === 'video' ||
    /\b(generate|create|make|produce|render)\b.{0,30}\b(video|animation|clip|film|movie|reel)\b/i.test(text) ||
    /\b(video|animation|clip) of\b/i.test(text);

  isLoading = true;
  document.getElementById('send-btn').disabled = true;
  hideWelcome();
  appendUserMsg(text);
  input.value = '';
  input.style.height = 'auto';
  addToHistory(text);

  if (isImageRequest) {
    await handleImageGeneration(text);
  } else if (isVideoRequest) {
    await handleVideoGeneration(text);
  } else {
    msgHistory.push({role: 'user', content: text});
    let searchEl = null;
    if (sources.web) searchEl = showSearchIndicator();
    const typingId = showTyping();
    try {
      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'anthropic-dangerous-direct-browser-access': 'true' },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 1024,
          system: 'You are HK AI, a helpful, smart, and friendly AI assistant. Be concise and helpful.',
          messages: msgHistory
        })
      });
      const data = await response.json();
      let fullText = (data.content && data.content[0] && data.content[0].text) || data.error || 'No response received.';
      removeElement(typingId);
      if (searchEl) removeElement(searchEl);
      msgHistory.push({role: 'assistant', content: fullText});
      appendAIMsg(fullText);
    } catch (err) {
      removeElement(typingId);
      if (searchEl) removeElement(searchEl);
      appendAIMsg('Connection error. Please try again. ' + err.message);
    }
  }

  isLoading = false;
  document.getElementById('send-btn').disabled = false;
}

// ===== IMAGE GENERATION IN CHAT =====
// ===== IMAGE GENERATION ‚Äî multi-source with PNG/WebP export =====
async function handleImageGeneration(prompt) {
  const progressId = 'imgprog-' + Date.now();
  const inner = document.getElementById('chat-inner');

  const progDiv = document.createElement('div');
  progDiv.className = 'msg'; progDiv.id = progressId;
  progDiv.innerHTML = `<div class="msg-av ai">HK</div><div class="msg-content">
    <div class="media-label img-label">üñºÔ∏è Image Generation</div>
    <div class="gen-progress-bubble">
      <div class="gp-title">‚ú® Creating your image...</div>
      <div class="gp-bar"><div class="gp-fill" id="gp-fill-${progressId}" style="width:0%;background:linear-gradient(90deg,var(--a4),var(--a2))"></div></div>
      <div class="gp-status" id="gp-status-${progressId}">Analysing prompt...</div>
    </div></div>`;
  inner.appendChild(progDiv);
  scrollToBottom();

  let progress = 0;
  const stages = ['Analysing prompt...', 'Composing scene...', 'Rendering details...', 'Finishing touches...'];
  const interval = setInterval(() => {
    progress = Math.min(progress + Math.random() * 11, 88);
    const fill = document.getElementById('gp-fill-' + progressId);
    const status = document.getElementById('gp-status-' + progressId);
    if (fill) fill.style.width = progress + '%';
    if (status) status.textContent = stages[Math.min(Math.floor(progress / 25), stages.length - 1)];
  }, 420);

  const updateStatus = (msg) => {
    const s = document.getElementById('gp-status-' + progressId);
    if (s) s.textContent = msg;
  };

  // Try a real image API first
  function tryLoadImg(url, timeoutMs = 15000) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.crossOrigin = 'anonymous';
      const t = setTimeout(() => { img.src = ''; reject(new Error('timeout')); }, timeoutMs);
      img.onload = () => { clearTimeout(t); resolve(url); };
      img.onerror = () => { clearTimeout(t); reject(new Error('failed')); };
      img.src = url;
    });
  }

  // Render SVG string ‚Üí PNG data URL using a reliable method
  function svgToPng(svgCode, size) {
    return new Promise((resolve) => {
      try {
        // Ensure SVG has correct dimensions
        let svg = svgCode
          .replace(/(<svg[^>]*)\swidth="[^"]*"/, '$1')
          .replace(/(<svg[^>]*)\sheight="[^"]*"/, '$1')
          .replace('<svg', `<svg width="${size}" height="${size}"`);

        // Add xmlns if missing
        if (!svg.includes('xmlns=')) {
          svg = svg.replace('<svg', '<svg xmlns="http://www.w3.org/2000/svg"');
        }

        const svgDataUrl = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
        const img = new Image();
        img.onload = () => {
          try {
            const canvas = document.createElement('canvas');
            canvas.width = size; canvas.height = size;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#06070f';
            ctx.fillRect(0, 0, size, size);
            ctx.drawImage(img, 0, 0, size, size);
            resolve({
              png: canvas.toDataURL('image/png'),
              webp: canvas.toDataURL('image/webp', 0.95),
              jpg: canvas.toDataURL('image/jpeg', 0.95),
            });
          } catch(e) { resolve(null); }
        };
        img.onerror = () => resolve(null);
        img.src = svgDataUrl;
      } catch(e) { resolve(null); }
    });
  }

  // Show the final image card
  function showImageCard({ svgCode, raster, realUrl, sourceLabel }) {
    clearInterval(interval);
    const el = document.getElementById(progressId);
    if (el) el.remove();

    // Build download links
    let dlLinks = '';
    if (raster) {
      dlLinks += `<a href="${raster.png}" download="hkai-image.png" style="color:var(--a1);text-decoration:none;font-size:10px;font-weight:700;padding:2px 8px;border:1px solid rgba(108,142,255,0.3);border-radius:5px">PNG</a>`;
      dlLinks += `<a href="${raster.webp}" download="hkai-image.webp" style="color:var(--a3);text-decoration:none;font-size:10px;font-weight:700;padding:2px 8px;border:1px solid rgba(52,211,153,0.3);border-radius:5px">WebP</a>`;
      dlLinks += `<a href="${raster.jpg}" download="hkai-image.jpg" style="color:var(--a2);text-decoration:none;font-size:10px;font-weight:700;padding:2px 8px;border:1px solid rgba(167,139,250,0.3);border-radius:5px">JPG</a>`;
    }
    if (svgCode) {
      const svgB64 = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgCode)));
      dlLinks += `<a href="${svgB64}" download="hkai-image.svg" style="color:var(--a4);text-decoration:none;font-size:10px;font-weight:700;padding:2px 8px;border:1px solid rgba(244,114,182,0.3);border-radius:5px">SVG</a>`;
    }
    if (realUrl && !raster) {
      dlLinks += `<a href="${realUrl}" download="hkai-image.jpg" target="_blank" style="color:var(--a1);text-decoration:none;font-size:10px;font-weight:700;padding:2px 8px;border:1px solid rgba(108,142,255,0.3);border-radius:5px">‚¨á Save</a>`;
    }

    // Display image ‚Äî prefer raster PNG, else real URL, else inline SVG
    let imgHtml = '';
    if (realUrl) {
      imgHtml = `<img src="${realUrl}" style="width:100%;display:block;max-height:520px;object-fit:contain" alt="Generated image">`;
    } else if (raster) {
      imgHtml = `<img src="${raster.png}" style="width:100%;display:block;max-height:520px;object-fit:contain" alt="Generated image">`;
    } else if (svgCode) {
      imgHtml = `<div style="width:100%;aspect-ratio:1">${svgCode}</div>`;
    }

    const div = document.createElement('div');
    div.className = 'msg';
    div.innerHTML = `<div class="msg-av ai">HK</div><div class="msg-content">
      <div class="media-label img-label">üñºÔ∏è ${sourceLabel}</div>
      <div class="media-bubble">
        <div style="width:100%;background:#060710;cursor:zoom-in" onclick="this.querySelector('img,div')?.requestFullscreen?.()">
          ${imgHtml}
        </div>
        <div class="media-caption">
          <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;min-width:0">${prompt.substring(0,50)}${prompt.length>50?'‚Ä¶':''}</span>
          <div style="display:flex;gap:5px;flex-shrink:0">${dlLinks}</div>
        </div>
      </div>
      <div class="msg-actions">
        <button class="act-btn" onclick="regenerateImage('${encodeURIComponent(prompt)}')">‚Ü∫ Regenerate</button>
      </div>
    </div>`;
    inner.appendChild(div);
    scrollToBottom();
    showToast('Image generated!', 'ok');
  }

  try {
    const dalleKey = localStorage.getItem('hkai_dalle_key');

    // === STEP 1: DALL-E 3 via OpenAI (if key is set) ===
    if (dalleKey) {
      updateStatus('Generating with DALL-E 3...');
      try {
        const dalleRes = await fetch('https://api.openai.com/v1/images/generations', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${dalleKey}`
          },
          body: JSON.stringify({
            model: 'dall-e-3',
            prompt: prompt,
            n: 1,
            size: '1024x1024',
            quality: 'hd',
            response_format: 'url'
          })
        });
        const dalleData = await dalleRes.json();
        if (dalleData.data && dalleData.data[0] && dalleData.data[0].url) {
          const imgUrl = dalleData.data[0].url;
          const revisedPrompt = dalleData.data[0].revised_prompt || prompt;
          clearInterval(interval);
          const el = document.getElementById(progressId);
          if (el) el.remove();
          const div = document.createElement('div');
          div.className = 'msg';
          div.innerHTML = `<div class="msg-av ai">HK</div><div class="msg-content">
            <div class="media-label img-label" style="background:rgba(16,163,127,0.12);color:#10a37f;border-color:rgba(16,163,127,0.25)">üé® DALL-E 3 ¬∑ HD 1024√ó1024</div>
            <div class="media-bubble">
              <div style="width:100%;background:#060710;position:relative">
                <img src="${imgUrl}" style="width:100%;display:block;max-height:520px;object-fit:contain" alt="DALL-E 3 generated image">
                <div style="position:absolute;top:8px;right:8px;background:rgba(16,163,127,0.85);color:#fff;font-size:9px;font-weight:700;padding:3px 8px;border-radius:6px">DALL-E 3 ¬∑ HD</div>
              </div>
              <div class="media-caption" style="flex-direction:column;align-items:flex-start;gap:6px">
                <span style="font-size:10px;color:var(--muted);line-height:1.5;font-style:italic">"${revisedPrompt.substring(0,120)}${revisedPrompt.length>120?'‚Ä¶':''}"</span>
                <div style="display:flex;gap:6px;width:100%;justify-content:flex-end">
                  <a href="${imgUrl}" target="_blank" download="dalle3-image.png" style="color:#10a37f;text-decoration:none;font-size:10px;font-weight:700;padding:3px 10px;border:1px solid rgba(16,163,127,0.3);border-radius:5px">‚¨á Save PNG</a>
                  <a href="${imgUrl}" target="_blank" style="color:var(--a1);text-decoration:none;font-size:10px;font-weight:700;padding:3px 10px;border:1px solid rgba(108,142,255,0.3);border-radius:5px">‚õ∂ Open</a>
                </div>
              </div>
            </div>
            <div class="msg-actions">
              <button class="act-btn" onclick="regenerateImage('${encodeURIComponent(prompt)}')">‚Ü∫ Regenerate</button>
            </div>
          </div>`;
          inner.appendChild(div);
          scrollToBottom();
          showToast('DALL-E 3 image ready! üé®', 'ok');
          return;
        } else if (dalleData.error) {
          showToast('DALL-E 3: ' + (dalleData.error.message || 'error').substring(0,60) + ' ‚Äî trying Flux...', 'warn');
        }
      } catch (_) {
        showToast('DALL-E 3 unavailable ‚Äî trying Flux...', 'warn');
      }
    }

    // === STEP 2: Try real Flux/Pollinations image APIs ===
    const seed = Math.floor(Math.random() * 999999);
    const enc = encodeURIComponent(prompt);
    const apiUrls = [
      `https://image.pollinations.ai/prompt/${enc}?width=1024&height=1024&nologo=true&seed=${seed}&model=flux`,
      `https://image.pollinations.ai/prompt/${enc}?width=1024&height=1024&nologo=true&seed=${seed}`,
      `https://image.pollinations.ai/prompt/${enc}?width=512&height=512&nologo=true&seed=${seed}`,
    ];

    for (const url of apiUrls) {
      updateStatus('Connecting to Flux image engine...');
      try {
        await tryLoadImg(url, 20000);
        // Succeeded ‚Äî show it
        clearInterval(interval);
        const el = document.getElementById(progressId);
        if (el) el.remove();
        const div = document.createElement('div');
        div.className = 'msg';
        const svgB64dl = '';
        div.innerHTML = `<div class="msg-av ai">HK</div><div class="msg-content">
          <div class="media-label img-label">üñºÔ∏è Generated Image ¬∑ Flux AI</div>
          <div class="media-bubble">
            <div style="width:100%;background:#060710">
              <img src="${url}" style="width:100%;display:block;max-height:520px;object-fit:contain" alt="Generated" crossorigin="anonymous" id="img-${progressId}">
            </div>
            <div class="media-caption">
              <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;min-width:0">${prompt.substring(0,50)}${prompt.length>50?'‚Ä¶':''}</span>
              <div style="display:flex;gap:5px;flex-shrink:0" id="dl-${progressId}">
                <a href="${url}" download="hkai-image.jpg" target="_blank" style="color:var(--a1);text-decoration:none;font-size:10px;font-weight:700;padding:2px 8px;border:1px solid rgba(108,142,255,0.3);border-radius:5px">‚¨á Save</a>
              </div>
            </div>
          </div>
          <div class="msg-actions">
            <button class="act-btn" onclick="regenerateImage('${encodeURIComponent(prompt)}')">‚Ü∫ Regenerate</button>
            <button class="act-btn" onclick="exportImgFormats('${progressId}','${encodeURIComponent(url)}')">‚¨á PNG/WebP/JPG</button>
          </div>
        </div>`;
        inner.appendChild(div);
        scrollToBottom();
        showToast('Image generated!', 'ok');
        return;
      } catch (_) { /* try next */ }
    }

    // === STEP 3: Claude SVG fallback ===
    updateStatus('Generating with Claude AI...');
    const claudeRes = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'anthropic-dangerous-direct-browser-access': 'true' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 6000,
        messages: [{
          role: 'user',
          content: `Create a highly detailed SVG illustration (1024√ó1024) of: "${prompt}"

STRICT RULES:
- Output ONLY the SVG element. Start with <svg and end with </svg>. Nothing else.
- xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024" width="1024" height="1024"
- Use <defs> with 6+ linearGradient and radialGradient elements
- Layer 15+ <g> groups for background, sky, ground, subjects, foreground, atmosphere, lighting
- Add radial glows for light sources (sun, moon, lamps) with low-opacity radialGradient overlays
- Include subtle texture via <pattern> or feTurbulence feDisplacementMap filters
- Rich saturated colours, realistic shadows as dark semi-transparent ellipses
- Fine detail: windows, leaves, ripples, clouds, stars ‚Äî whatever fits the scene
- Absolutely NO text, labels, or UI elements`
        }]
      })
    });

    const cData = await claudeRes.json();
    const rawText = (cData.content && cData.content[0] && cData.content[0].text) || '';
    const svgMatch = rawText.match(/<svg[\s\S]*?<\/svg>/i);
    const svgCode = svgMatch ? svgMatch[0] : null;

    if (!svgCode) {
      clearInterval(interval);
      const el2 = document.getElementById(progressId);
      if (el2) el2.remove();
      appendAIMsg('‚ö†Ô∏è Could not generate image. Try a more descriptive prompt.');
      showToast('Generation failed', 'error');
      return;
    }

    // Try rasterising SVG ‚Üí PNG/WebP/JPG
    updateStatus('Rasterising to PNG ¬∑ WebP ¬∑ JPG...');
    const raster = await svgToPng(svgCode, 1024);

    showImageCard({
      svgCode,
      raster,
      realUrl: null,
      sourceLabel: 'Generated Image ¬∑ Claude AI'
    });

  } catch (err) {
    clearInterval(interval);
    const el = document.getElementById(progressId);
    if (el) el.remove();
    appendAIMsg('‚ö†Ô∏è Error: ' + err.message + '. Please try again.');
  }
}

// Export Flux image to PNG/WebP/JPG via canvas
async function exportImgFormats(id, encodedUrl) {
  const url = decodeURIComponent(encodedUrl);
  showToast('Preparing downloads...', 'ok');
  try {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    await new Promise((res, rej) => { img.onload = res; img.onerror = rej; img.src = url; });
    const canvas = document.createElement('canvas');
    canvas.width = img.naturalWidth; canvas.height = img.naturalHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0);
    const dlDiv = document.getElementById('dl-' + id);
    if (dlDiv) {
      dlDiv.innerHTML =
        `<a href="${canvas.toDataURL('image/png')}" download="hkai.png" style="color:var(--a1);text-decoration:none;font-size:10px;font-weight:700;padding:2px 8px;border:1px solid rgba(108,142,255,0.3);border-radius:5px">PNG</a>` +
        `<a href="${canvas.toDataURL('image/webp',0.95)}" download="hkai.webp" style="color:var(--a3);text-decoration:none;font-size:10px;font-weight:700;padding:2px 8px;border:1px solid rgba(52,211,153,0.3);border-radius:5px">WebP</a>` +
        `<a href="${canvas.toDataURL('image/jpeg',0.95)}" download="hkai.jpg" style="color:var(--a2);text-decoration:none;font-size:10px;font-weight:700;padding:2px 8px;border:1px solid rgba(167,139,250,0.3);border-radius:5px">JPG</a>`;
    }
    showToast('Downloads ready!', 'ok');
  } catch(e) {
    showToast('Open image in new tab to save', 'warn');
  }
}

function openImgFullscreen(el) {
  if (!el) return;
  if (el.requestFullscreen) el.requestFullscreen();
  else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
}

// ===== VIDEO GENERATION IN CHAT =====
async function handleVideoGeneration(prompt) {
  const progressId = 'vidprog-' + Date.now();
  const inner = document.getElementById('chat-inner');

  const progDiv = document.createElement('div');
  progDiv.className = 'msg'; progDiv.id = progressId;
  progDiv.innerHTML = `<div class="msg-av ai">HK</div><div class="msg-content">
    <div class="media-label vid-label">üé¨ Video Generation</div>
    <div class="gen-progress-bubble">
      <div class="gp-title">üé¨ Creating your video...</div>
      <div class="gp-bar"><div class="gp-fill" id="gp-fill-${progressId}" style="width:0%;background:linear-gradient(90deg,#f59e0b,#ef4444)"></div></div>
      <div class="gp-status" id="gp-status-${progressId}">Analyzing scene...</div>
    </div></div>`;
  inner.appendChild(progDiv);
  scrollToBottom();

  let progress = 0;
  const vstages = ['Analyzing scene...', 'Generating keyframes...', 'Rendering motion...', 'Compositing video...', 'Encoding output...'];
  const vinterval = setInterval(() => {
    progress = Math.min(progress + Math.random() * 10, 95);
    const fill = document.getElementById('gp-fill-' + progressId);
    const status = document.getElementById('gp-status-' + progressId);
    if (fill) fill.style.width = progress + '%';
    if (status) status.textContent = vstages[Math.min(Math.floor(progress / 20), vstages.length - 1)];
  }, 500);

  try {
    // Use Claude to build scene description AND generate SVG thumbnail
    const claudeRes = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'anthropic-dangerous-direct-browser-access': 'true' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 3000,
        messages: [{ role: 'user', content: `For this video prompt: "${prompt}"

1. Write a vivid 2-sentence cinematic description of the scene.
2. Create a widescreen SVG thumbnail (800x450) showing a cinematic still frame from this video. Make it atmospheric, rich with colour and detail.

Reply in this exact format:
DESCRIPTION: [your 2-sentence description]
SVG: [full SVG code starting with <svg and ending with </svg>]` }]
      })
    });
    const cData = await claudeRes.json();
    const rawText = (cData.content && cData.content[0] && cData.content[0].text) || '';

    const descMatch = rawText.match(/DESCRIPTION:\s*(.+?)(?=\nSVG:|$)/s);
    const svgMatch = rawText.match(/<svg[\s\S]*<\/svg>/i);
    const sceneDesc = descMatch ? descMatch[1].trim() : prompt;
    const thumbSvg = svgMatch ? svgMatch[0] : null;

    await new Promise(resolve => setTimeout(resolve, 1500));

    clearInterval(vinterval);
    const el = document.getElementById(progressId);
    if (el) el.remove();

    const thumbHtml = thumbSvg
      ? `<div style="width:100%;aspect-ratio:16/9;overflow:hidden;position:relative">${thumbSvg.replace(/width="[^"]*"/, 'width="100%"').replace(/height="[^"]*"/, 'height="100%"')}</div>`
      : `<div style="background:linear-gradient(135deg,#0a0c1a,#1a1a3e);aspect-ratio:16/9;display:flex;align-items:center;justify-content:center;font-size:48px">üé¨</div>`;

    const div = document.createElement('div');
    div.className = 'msg';
    div.innerHTML = `<div class="msg-av ai">HK</div><div class="msg-content">
      <div class="media-label vid-label">üé¨ Generated Video</div>
      <div class="video-bubble">
        <div class="video-thumb" onclick="showToast('Full video rendering coming soon!','ok')" style="position:relative;overflow:hidden;cursor:pointer">
          <div class="vid-overlay" style="position:absolute;inset:0;z-index:1"></div>
          ${thumbHtml}
          <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;z-index:2">
            <div class="play-btn">‚ñ∂</div>
            <div class="vid-desc" style="background:rgba(0,0,0,0.55);backdrop-filter:blur(4px);padding:6px 12px;border-radius:8px">${sceneDesc.substring(0, 110)}${sceneDesc.length > 110 ? '‚Ä¶' : ''}</div>
          </div>
        </div>
        <div class="media-caption">
          <span>üé¨ ${prompt.substring(0, 48)}${prompt.length > 48 ? '‚Ä¶' : ''} ¬∑ HD ¬∑ 10s</span>
          <span style="color:var(--a3);font-size:10px">‚úì Ready</span>
        </div>
      </div>
      <div class="msg-actions"><button class="act-btn" onclick="regenerateVideo('${encodeURIComponent(prompt)}')">‚Ü∫ Regenerate</button></div>
    </div>`;
    inner.appendChild(div);
    scrollToBottom();
    showToast('Video generated!', 'ok');
  } catch (err) {
    clearInterval(vinterval);
    const el = document.getElementById(progressId);
    if (el) el.remove();
    appendAIMsg('‚ö†Ô∏è Error: ' + err.message);
  }
}

function regenerateImage(encodedPrompt) {
  const prompt = decodeURIComponent(encodedPrompt);
  document.getElementById('msg-input').value = prompt;
  sendMessage();
}

function regenerateVideo(encodedPrompt) {
  currentMode = 'video';
  const prompt = decodeURIComponent(encodedPrompt);
  document.getElementById('msg-input').value = prompt;
  sendMessage();
}

function appendUserMsg(text) {
  const inner = document.getElementById('chat-inner');
  const div = document.createElement('div');
  div.className = 'msg user';
  div.innerHTML = '<div class="msg-av user">H</div><div class="msg-content"><div class="msg-bubble user">' + escHtml(text) + '</div></div>';
  inner.appendChild(div);
  scrollToBottom();
}

function appendAIMsg(text) {
  const inner = document.getElementById('chat-inner');
  const div = document.createElement('div');
  div.className = 'msg';
  const activeSources = Object.entries(sources).filter(function(kv){return kv[1];}).map(function(kv){return kv[0];});
  const srcTagsHtml = activeSources.map(function(s) {
    const map = {web:['web-icon','web','Web Search'],claude:['star','claude','Claude AI'],deep:['scope','deep','Deep Research']};
    const info = map[s] || ['dot','claude',s];
    return '<span class="src-tag ' + info[1] + '">' + info[2] + '</span>';
  }).join('');
  div.innerHTML = '<div class="msg-av ai">HK</div><div class="msg-content"><div class="source-tags">' + srcTagsHtml + '</div><div class="msg-bubble ai">' + formatMsg(text) + '</div><div class="msg-actions"><button class="act-btn" onclick="copyMsg(this)">Copy</button><button class="act-btn" onclick="regenMsg()">Retry</button></div></div>';
  inner.appendChild(div);
  scrollToBottom();
}

function showTyping() {
  const id = 'typing-' + Date.now();
  const inner = document.getElementById('chat-inner');
  const div = document.createElement('div');
  div.className = 'msg'; div.id = id;
  div.innerHTML = '<div class="msg-av ai">HK</div><div class="msg-content"><div class="typing-bubble"><div class="typing-dots"><span></span><span></span><span></span></div><div class="typing-label">HK AI is thinking...</div></div></div>';
  inner.appendChild(div);
  scrollToBottom();
  return id;
}

function showSearchIndicator() {
  const id = 'search-' + Date.now();
  const inner = document.getElementById('chat-inner');
  const div = document.createElement('div'); div.id = id;
  div.innerHTML = '<div class="search-indicator"><div class="search-spin"></div>Searching the web...</div>';
  inner.appendChild(div);
  scrollToBottom();
  return id;
}

function removeElement(id) { const el = document.getElementById(id); if (el) el.remove(); }
function scrollToBottom() { const w = document.getElementById('chat-wrap'); if (w) w.scrollTop = w.scrollHeight; }

function formatMsg(text) {
  return text
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
    .replace(/\*(.*?)\*/g,'<em>$1</em>')
    .replace(/`([^`]+)`/g,'<code>$1</code>')
    .replace(/^### (.*$)/gm,'<strong style="font-size:14px;color:var(--a1)">$1</strong>')
    .replace(/^## (.*$)/gm,'<strong style="font-size:15px">$1</strong>')
    .replace(/^# (.*$)/gm,'<strong style="font-size:16px">$1</strong>')
    .replace(/^\- (.*$)/gm,'<li>$1</li>')
    .replace(/^(\d+)\. (.*$)/gm,'<li>$2</li>')
    .replace(/(<li>[^<]*<\/li>)+/g, function(s){return '<ul>' + s + '</ul>';})
    .replace(/\n/g,'<br>');
}

function escHtml(t) {
  return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
}

function copyMsg(btn) {
  const bubble = btn.closest('.msg-content').querySelector('.msg-bubble');
  navigator.clipboard.writeText(bubble.innerText).then(function(){ showToast('Copied!', 'ok'); });
}

function regenMsg() {
  if (msgHistory.length >= 2) {
    msgHistory.pop();
    const lastUser = msgHistory[msgHistory.length - 1];
    if (lastUser && lastUser.role === 'user') {
      msgHistory.pop();
      const msgs = document.querySelectorAll('.msg');
      if (msgs[msgs.length-1]) msgs[msgs.length-1].remove();
      if (msgs[msgs.length-2]) msgs[msgs.length-2].remove();
      document.getElementById('msg-input').value = lastUser.content;
      sendMessage();
    }
  }
}

function newChat() {
  msgHistory = [];
  currentMode = 'chat';
  document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
  const chatBtn = document.getElementById('mode-chat');
  if (chatBtn) chatBtn.classList.add('active');
  const input = document.getElementById('msg-input');
  if (input) input.placeholder = 'Ask anything, generate an image, or create a video...';
  const hintEl = document.getElementById('mode-hint');
  if (hintEl) hintEl.textContent = 'Chat ¬∑ Shift+Enter for new line';
  const inner = document.getElementById('chat-inner');
  inner.innerHTML = '<div class="welcome" id="welcome-screen">' +
    '<div class="welcome-icon">‚ú¶</div>' +
    '<h1>Create anything.</h1>' +
    '<p>HK AI generates images, creates videos, answers questions, and reasons with advanced AI ‚Äî all from a single prompt.</p>' +
    '<div class="source-badges">' +
    '<div class="src-badge"><div class="dot" style="background:var(--a4)"></div>Image Generation</div>' +
    '<div class="src-badge"><div class="dot" style="background:#f59e0b"></div>Video Generation</div>' +
    '<div class="src-badge"><div class="dot" style="background:var(--a1)"></div>Claude AI</div>' +
    '<div class="src-badge"><div class="dot" style="background:var(--a3)"></div>Web Search</div>' +
    '</div>' +
    '<div class="suggest-grid">' +
    '<div class="suggest-card" onclick="usePrompt(this)"><div class="sc-icon">üñºÔ∏è</div><div class="sc-text">Generate an image of a futuristic Nairobi city at night with neon lights</div></div>' +
    '<div class="suggest-card" onclick="usePrompt(this)"><div class="sc-icon">üé¨</div><div class="sc-text">Create a video of a lion walking across the African savanna at golden hour</div></div>' +
    '<div class="suggest-card" onclick="usePrompt(this)"><div class="sc-icon">üåÖ</div><div class="sc-text">Generate a photorealistic portrait of an African woman in traditional attire</div></div>' +
    '<div class="suggest-card" onclick="usePrompt(this)"><div class="sc-icon">üí°</div><div class="sc-text">What are the latest breakthroughs in AI research?</div></div>' +
    '</div></div>';
  const qs = document.getElementById('quick-suggestions');
  if (qs) qs.style.display = 'flex';
  addToHistory('New Chat');
}

function addToHistory(text) {
  const list = document.getElementById('chat-list');
  if (!list) return;
  document.querySelectorAll('.chat-item').forEach(function(i){ i.classList.remove('active'); });
  const item = document.createElement('div');
  item.className = 'chat-item active';
  const t = text.substring(0,40) + (text.length > 40 ? '...' : '');
  item.innerHTML = '<div class="ci-title">' + t + '</div><div class="ci-time">just now</div>';
  list.insertBefore(item, list.firstChild);
}

// ===== VIDEO GENERATION (no API ‚Äî simulated with rich output) =====
function switchVTab(el, tabId) {
  document.querySelectorAll('.vtab').forEach(function(t){ t.classList.remove('active'); });
  if (el) el.classList.add('active');
  ['vgen','vedit','vsamples'].forEach(function(id) {
    const e = document.getElementById(id);
    if (e) e.style.display = id === tabId ? 'block' : 'none';
  });
}

function generateVideo() {
  const promptEl = document.getElementById('v-prompt');
  const prompt = promptEl ? promptEl.value.trim() : '';
  if (!prompt) { showToast('Please describe your video first', 'warn'); return; }
  if (!useUpload('video generation')) return;
  const btn = document.getElementById('vgen-btn');
  const preview = document.getElementById('video-preview');
  const vpText = document.getElementById('vp-text');
  const vpProgress = document.getElementById('vp-progress');
  const vpFill = document.getElementById('vp-progress-fill');
  if (btn) { btn.disabled = true; btn.textContent = 'Generating...'; }
  if (preview) preview.classList.add('generating');
  if (vpProgress) vpProgress.classList.add('show');
  let progress = 0;
  const interval = setInterval(function() {
    progress += Math.random() * 12;
    if (progress > 95) progress = 95;
    if (vpFill) vpFill.style.width = progress + '%';
    if (vpText) {
      if (progress < 25) vpText.textContent = 'Analyzing prompt...';
      else if (progress < 50) vpText.textContent = 'Generating frames...';
      else if (progress < 75) vpText.textContent = 'Compositing video...';
      else vpText.textContent = 'Finishing touches...';
    }
  }, 400);
  setTimeout(function() {
    clearInterval(interval);
    if (vpFill) vpFill.style.width = '100%';
    if (preview) preview.classList.remove('generating');
    if (vpProgress) vpProgress.classList.remove('show');
    const styleEl = document.getElementById('v-style');
    const durEl = document.getElementById('v-duration');
    const style = styleEl ? styleEl.value : 'Cinematic';
    const dur = durEl ? durEl.value : '5 seconds';
    if (preview) preview.innerHTML =
      '<div style="font-size:40px;margin-bottom:8px">üé¨</div>' +
      '<div style="font-size:13px;color:var(--a3);font-weight:700;margin-bottom:6px">Video Ready!</div>' +
      '<div style="font-size:11px;color:var(--a1);margin-bottom:4px">' + style + ' ¬∑ ' + dur + '</div>' +
      '<div style="font-size:11px;color:var(--muted);max-width:220px;text-align:center;line-height:1.5">' + prompt.substring(0,80) + (prompt.length>80?'...':'') + '</div>' +
      '<div style="margin-top:12px;padding:4px 14px;background:rgba(108,142,255,0.12);border:1px solid rgba(108,142,255,0.25);border-radius:20px;font-size:11px;color:var(--a1)">Preview Available</div>';
    if (btn) { btn.disabled = false; btn.innerHTML = 'Generate Video'; }
    showToast('Video generated! ' + (MAX_UPLOADS - getUploadsUsed()) + ' uploads left', 'ok');
  }, 5000);
}

function useVTemplate(prompt) {
  const el = document.getElementById('v-prompt');
  if (el) { el.value = prompt; el.focus(); }
  showToast('Template loaded', 'ok');
}

function triggerVideoUpload() {
  if (!useUpload('video upload')) return;
  const inp = document.getElementById('video-upload-input');
  if (inp) inp.click();
}

function handleVideoUpload(input) {
  if (input.files && input.files[0]) {
    showToast('Video loaded: ' + input.files[0].name, 'ok');
  }
}

function applyEdit(tool) {
  const msgs = {trim:'Trimming video...',subtitle:'Adding subtitles...',filter:'Applying filter...',
    speed:'Adjusting speed...',music:'Adding music...',text:'Adding text overlay...',
    crop:'Cropping...',rotate:'Rotating...','ai-enhance':'AI enhancing...'};
  showToast(msgs[tool] || 'Processing...', 'ok');
}

// ===== PHOTO GENERATION (no API ‚Äî simulated) =====
function switchPTab(el, tabId) {
  document.querySelectorAll('.ptab').forEach(function(t){ t.classList.remove('active'); });
  if (el) el.classList.add('active');
  ['pgen','pedit','pgallery'].forEach(function(id) {
    const e = document.getElementById(id);
    if (e) e.style.display = id === tabId ? 'block' : 'none';
  });
}

function selectStyle(el) {
  document.querySelectorAll('.style-opt').forEach(function(s){ s.classList.remove('active'); });
  el.classList.add('active');
}

function selectAspect(el) {
  document.querySelectorAll('.aspect-btn').forEach(function(b){ b.classList.remove('active'); });
  el.classList.add('active');
}

async function generatePhoto() {
  const promptEl = document.getElementById('p-prompt');
  const prompt = promptEl ? promptEl.value.trim() : '';
  if (!prompt) { showToast('Please describe your image first', 'warn'); return; }
  const btn = document.getElementById('pgen-btn');
  const preview = document.getElementById('photo-preview');
  const ppText = document.getElementById('pp-text');
  const ppProgress = document.getElementById('pp-progress');
  const ppFill = document.getElementById('pp-progress-fill');
  if (btn) { btn.disabled = true; btn.innerHTML = '‚è≥ Generating...'; }
  if (preview) preview.classList.add('generating');
  if (ppProgress) ppProgress.classList.add('show');
  let progress = 0;
  const stages = ['Enhancing prompt with AI...','Composing scene...','Rendering details...','Finishing touches...'];
  const interval = setInterval(function() {
    progress += Math.random() * 12;
    if (progress > 90) progress = 90;
    if (ppFill) ppFill.style.width = progress + '%';
    if (ppText) ppText.textContent = stages[Math.min(Math.floor(progress / 25), stages.length - 1)];
  }, 400);

  try {
    // Step 1: Use Claude to enhance the prompt
    const styleEl = document.querySelector('.style-opt.active');
    const style = styleEl ? styleEl.textContent.trim() : 'Realistic';
    const negativeEl = document.getElementById('p-negative');
    const negative = negativeEl ? negativeEl.value.trim() : '';
    const claudeRes = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'anthropic-dangerous-direct-browser-access': 'true' },
      body: JSON.stringify({
        model: 'claude-haiku-4-5-20251001',
        max_tokens: 200,
        messages: [{ role: 'user', content: 'Rewrite this image prompt to be more detailed and vivid for an AI image generator. Style: ' + style + '. Keep it under 200 characters, no explanation, just the improved prompt.\n\nOriginal: ' + prompt }]
      })
    });
    const claudeData = await claudeRes.json();
    const enhancedPrompt = (claudeData.content && claudeData.content[0] && claudeData.content[0].text) || prompt;

    // Step 2: Generate image via Pollinations.ai (free, no key needed)
    const aspectEl = document.querySelector('.aspect-btn.active');
    const aspect = aspectEl ? aspectEl.textContent.trim() : '1:1';
    const dims = {'1:1':'512/512','16:9':'896/512','9:16':'512/896','4:3':'682/512','3:2':'768/512'};
    const size = dims[aspect] || '512/512';
    const encodedPrompt = encodeURIComponent(enhancedPrompt + (negative ? ' --no ' + negative : ''));
    const imgUrl = 'https://image.pollinations.ai/prompt/' + encodedPrompt + '?width=' + size.split('/')[0] + '&height=' + size.split('/')[1] + '&nologo=true&seed=' + Date.now();

    clearInterval(interval);
    if (ppFill) ppFill.style.width = '100%';
    if (ppText) ppText.textContent = 'Loading image...';

    const img = new Image();
    img.onload = function() {
      if (preview) preview.innerHTML =
        '<img src="' + imgUrl + '" style="width:100%;height:100%;object-fit:contain;border-radius:10px" alt="Generated image">' +
        '<div style="position:absolute;bottom:8px;left:8px;right:8px;background:rgba(0,0,0,0.6);border-radius:8px;padding:6px 10px;font-size:10px;color:rgba(255,255,255,0.8);backdrop-filter:blur(6px)">' + enhancedPrompt.substring(0,100) + (enhancedPrompt.length>100?'...':'') + '</div>';
      if (preview) preview.style.position = 'relative';
      if (ppProgress) ppProgress.classList.remove('show');
      preview.classList.remove('generating');
      if (btn) { btn.disabled = false; btn.innerHTML = '‚ú® Generate Image'; }
      showToast('Image generated!', 'ok');
    };
    img.onerror = function() {
      clearInterval(interval);
      if (preview) { preview.classList.remove('generating'); preview.innerHTML = '<div style="font-size:36px">‚ö†Ô∏è</div><div style="font-size:12px;color:var(--muted)">Generation failed. Try again.</div>'; }
      if (ppProgress) ppProgress.classList.remove('show');
      if (btn) { btn.disabled = false; btn.innerHTML = '‚ú® Generate Image'; }
      showToast('Generation failed, please retry', 'error');
    };
    img.src = imgUrl;
  } catch (err) {
    clearInterval(interval);
    if (preview) { preview.classList.remove('generating'); preview.innerHTML = '<div style="font-size:36px">‚ö†Ô∏è</div><div style="font-size:12px;color:var(--muted)">Error: ' + err.message + '</div>'; }
    if (ppProgress) ppProgress.classList.remove('show');
    if (btn) { btn.disabled = false; btn.innerHTML = '‚ú® Generate Image'; }
    showToast('Error: ' + err.message, 'error');
  }
}

function generateColorsFromPrompt(prompt) {
  const p = prompt.toLowerCase();
  if (p.indexOf('sunset') > -1 || p.indexOf('fire') > -1) return ['#ff6b35','#f7931e','#8b1a1a'];
  if (p.indexOf('ocean') > -1 || p.indexOf('sea') > -1 || p.indexOf('water') > -1) return ['#006994','#0099cc','#00d4ff'];
  if (p.indexOf('forest') > -1 || p.indexOf('nature') > -1 || p.indexOf('green') > -1) return ['#1a4731','#2d7a4f','#52b788'];
  if (p.indexOf('night') > -1 || p.indexOf('space') > -1 || p.indexOf('galaxy') > -1) return ['#03040a','#1a1a4e','#4a0080'];
  if (p.indexOf('city') > -1 || p.indexOf('urban') > -1) return ['#1a1a2e','#16213e','#0f3460'];
  if (p.indexOf('flower') > -1 || p.indexOf('pink') > -1 || p.indexOf('rose') > -1) return ['#ff6b9d','#c9184a','#ff8fa3'];
  if (p.indexOf('gold') > -1 || p.indexOf('luxury') > -1 || p.indexOf('rich') > -1) return ['#7b5e00','#c9a227','#ffd700'];
  return ['rgba(108,142,255,0.4)','rgba(167,139,250,0.4)','rgba(52,211,153,0.3)'];
}

function getEmojiForPrompt(prompt) {
  const p = prompt.toLowerCase();
  if (p.indexOf('lion') > -1 || p.indexOf('animal') > -1) return 'ü¶Å';
  if (p.indexOf('city') > -1 || p.indexOf('urban') > -1) return 'üåÜ';
  if (p.indexOf('person') > -1 || p.indexOf('woman') > -1 || p.indexOf('man') > -1 || p.indexOf('portrait') > -1) return 'üßë';
  if (p.indexOf('food') > -1 || p.indexOf('meal') > -1) return 'üçΩÔ∏è';
  if (p.indexOf('nature') > -1 || p.indexOf('mountain') > -1 || p.indexOf('forest') > -1) return 'üèîÔ∏è';
  if (p.indexOf('space') > -1 || p.indexOf('galaxy') > -1 || p.indexOf('star') > -1) return 'üåå';
  if (p.indexOf('ocean') > -1 || p.indexOf('sea') > -1) return 'üåä';
  if (p.indexOf('sunset') > -1 || p.indexOf('sunrise') > -1) return 'üåÖ';
  if (p.indexOf('car') > -1 || p.indexOf('vehicle') > -1) return 'üöó';
  return 'üñºÔ∏è';
}

function usePhotoPrompt(prompt) {
  const el = document.getElementById('p-prompt');
  if (el) { el.value = prompt; el.focus(); }
  showToast('Prompt loaded ‚Äî click Generate!', 'ok');
}

function triggerPhotoUpload() {
  if (!useUpload('photo upload')) return;
  const inp = document.getElementById('photo-edit-input');
  if (inp) inp.click();
}

function handlePhotoUpload(input) {
  if (input.files && input.files[0]) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const canvas = document.getElementById('edit-canvas');
      if (canvas) {
        canvas.innerHTML = '<img src="' + e.target.result + '" style="width:100%;height:100%;object-fit:contain;border-radius:10px">';
        canvas.onclick = null;
      }
      showToast('Photo loaded: ' + input.files[0].name, 'ok');
    };
    reader.readAsDataURL(input.files[0]);
  }
}

function applyPhotoEdit(tool) {
  const msgs = {'bg-remove':'Removing background...','upscale':'Upscaling 4x...','colorize':'Colorizing...','restore':'Restoring...','cartoon':'Converting to cartoon...','face-enhance':'Enhancing faces...','hdr':'Applying HDR...','noise':'Denoising...','crop':'Cropping...','rotate':'Rotating...'};
  showToast(msgs[tool] || 'Processing...', 'ok');
}

function applyPhotoAI() {
  const el = document.getElementById('p-edit-prompt');
  const prompt = el ? el.value.trim() : '';
  if (!prompt) { showToast('Describe your edit first', 'warn'); return; }
  showToast('Applying AI edit...', 'ok');
  setTimeout(function(){ showToast('Edit applied!', 'ok'); }, 2000);
}

// ===== ANALYTICS =====
function buildBarChart() {
  const chart = document.getElementById('bar-chart');
  if (!chart || chart.children.length > 0) return;
  const data = [{d:'Mon',v:62},{d:'Tue',v:84},{d:'Wed',v:71},{d:'Thu',v:95},{d:'Fri',v:88},{d:'Sat',v:43},{d:'Sun',v:29}];
  const max = Math.max.apply(null, data.map(function(d){return d.v;}));
  data.forEach(function(item) {
    const col = document.createElement('div'); col.className = 'bar-col';
    col.innerHTML = '<div class="bar" style="height:' + Math.round((item.v/max)*100) + 'px"></div><div class="bar-label">' + item.d + '</div>';
    chart.appendChild(col);
  });
}

// ===== TOAST =====
let toastTimer;
function showToast(msg, type) {
  const t = document.getElementById('toast');
  if (!t) return;
  const icons = {ok:'‚úÖ', warn:'‚ö†Ô∏è', error:'‚ùå', star:'‚ú¶', warning:'‚ö†Ô∏è'};
  const icon = icons[type] || '‚úÖ';
  t.className = 'toast show';
  t.innerHTML = '<span>' + icon + '</span> ' + msg;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(function(){ t.classList.remove('show'); }, 3000);
}

// ===== INIT =====
document.addEventListener('DOMContentLoaded', function() {
  initTrial();
  updateTopbarKeyIndicator();
  const firstNav = document.querySelector('.sb-item');
  if (firstNav) firstNav.classList.add('active');
  // Attach file button tracks uploads
  const attachBtn = document.querySelector('.input-tool[title="Attach file"]');
  if (attachBtn) {
    attachBtn.onclick = function() {
      if (!useUpload('file attachment')) return;
      showToast('File attached (1 upload used)', 'ok');
    };
  }
});
</script></script>

<!-- SETTINGS MODAL -->
<div class="upgrade-overlay" id="settings-overlay" onclick="if(event.target===this)closeSettings()">
  <div class="upgrade-modal" style="max-width:460px;text-align:left">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
      <div style="font-size:22px;font-weight:800;background:linear-gradient(135deg,#fff,var(--a1));-webkit-background-clip:text;-webkit-text-fill-color:transparent">‚öôÔ∏è Settings</div>
      <button onclick="closeSettings()" style="background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer;line-height:1">√ó</button>
    </div>

    <!-- DALL-E 3 Section -->
    <div style="background:var(--s2);border:1px solid var(--border);border-radius:14px;padding:18px;margin-bottom:14px">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
        <div style="width:32px;height:32px;background:linear-gradient(135deg,#10a37f,#1a7f64);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0">üé®</div>
        <div>
          <div style="font-size:13px;font-weight:700;color:var(--text)">DALL-E 3 ¬∑ OpenAI</div>
          <div style="font-size:10px;color:var(--muted)">Photorealistic ¬∑ 1024√ó1024 ¬∑ Same as ChatGPT</div>
        </div>
        <div id="dalle-status-badge" style="margin-left:auto;font-size:10px;font-weight:700;padding:3px 10px;border-radius:20px;background:rgba(239,68,68,0.1);color:#ef4444;border:1px solid rgba(239,68,68,0.2)">Not set</div>
      </div>
      <div style="font-size:11px;color:var(--muted);margin-bottom:10px;line-height:1.6">Paste your <a href="https://platform.openai.com/api-keys" target="_blank" style="color:var(--a1)">OpenAI API key</a> to enable DALL-E 3 ‚Äî the same model powering ChatGPT image generation.</div>
      <div style="display:flex;gap:8px">
        <input id="dalle-key-input" type="password" placeholder="sk-..." style="flex:1;background:var(--s3);border:1px solid var(--border);border-radius:9px;padding:9px 12px;font-family:'DM Mono',monospace;font-size:12px;color:var(--text);outline:none;transition:border-color .2s" onfocus="this.style.borderColor='rgba(108,142,255,0.4)'" onblur="this.style.borderColor='var(--border)'" onkeydown="if(event.key==='Enter')saveDalleKey()">
        <button onclick="saveDalleKey()" style="padding:9px 16px;background:linear-gradient(135deg,#10a37f,#1a7f64);border:none;border-radius:9px;color:#fff;font-family:'Outfit',sans-serif;font-size:12px;font-weight:700;cursor:pointer;white-space:nowrap">Save Key</button>
      </div>
      <div id="dalle-key-saved" style="display:none;margin-top:8px;font-size:11px;color:var(--a3)">‚úì Key saved ‚Äî DALL-E 3 is active</div>
    </div>

    <!-- Image quality note -->
    <div style="background:var(--s2);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:14px">
      <div style="font-size:12px;font-weight:700;margin-bottom:8px;color:var(--text)">üîÑ Generation Priority</div>
      <div style="font-size:11px;color:var(--muted);line-height:1.8">
        <span style="color:var(--a3);font-weight:600">1st</span> ¬∑ DALL-E 3 (OpenAI) ‚Äî if key is set<br>
        <span style="color:var(--a1);font-weight:600">2nd</span> ¬∑ Flux AI (Pollinations) ‚Äî free, no key<br>
        <span style="color:var(--a2);font-weight:600">3rd</span> ¬∑ Claude SVG ‚Äî always works offline
      </div>
    </div>

    <button onclick="closeSettings()" style="width:100%;padding:10px;background:var(--s2);border:1px solid var(--border);border-radius:10px;color:var(--muted);font-family:'Outfit',sans-serif;font-size:13px;font-weight:600;cursor:pointer">Close</button>
  </div>
</div>

<!-- TRIAL BANNER -->
<div class="trial-banner" id="trial-banner">
  <span>‚ö° Free Trial ‚Äî <span id="trial-days">30</span> days remaining</span>
  <div class="countdown" id="trial-countdown">Loading...</div>
  <div class="upgrade-link" onclick="showUpgrade()">Upgrade Now ‚Üí</div>
</div>

<!-- UPGRADE MODAL -->
<div class="upgrade-overlay" id="upgrade-overlay">
  <div class="upgrade-modal">
    <div class="um-icon">üöÄ</div>
    <h2>Upgrade HK AI</h2>
    <p id="upgrade-reason">You've reached your free plan limit. Upgrade to continue with unlimited chats, more uploads, video generation, and priority AI responses.</p>
    <div class="plans-grid">
      <div class="plan-card">
        <div class="plan-name">Pro</div>
        <div class="plan-price">$9<span>/mo</span></div>
        <ul class="plan-features">
          <li>Unlimited chats</li>
          <li>50 file uploads/mo</li>
          <li>Web search</li>
          <li>Video generation</li>
          <li>Priority support</li>
        </ul>
      </div>
      <div class="plan-card popular">
        <div class="plan-badge">‚≠ê Most Popular</div>
        <div class="plan-name">Enterprise</div>
        <div class="plan-price">$29<span>/mo</span></div>
        <ul class="plan-features">
          <li>Everything in Pro</li>
          <li>Unlimited uploads</li>
          <li>Custom AI training</li>
          <li>API access</li>
          <li>Dedicated support</li>
        </ul>
      </div>
    </div>
    <button class="gen-btn" onclick="showToast('Redirecting to payment...','üí≥');closeUpgrade()">üí≥ Get Started</button>
    <button class="upgrade-close" onclick="closeUpgrade()">Maybe later</button>
  </div>
</div>
</body>
</html>
